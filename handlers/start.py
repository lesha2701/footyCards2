from aiogram import Router, F
from aiogram.types import Message, CallbackQuery, InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.filters import CommandStart
from aiogram.fsm.context import FSMContext
import html

from db.user_queries import get_user_by_id, create_user

router = Router()

@router.message(CommandStart())
async def start(message: Message, state: FSMContext) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start —Å –∫—Ä–∞—Å–∏–≤—ã–º –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º"""
    user_id = message.from_user.id
    username = html.escape(message.from_user.full_name)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ë–î, –µ—Å–ª–∏ –Ω–µ—Ç - –¥–æ–±–∞–≤–ª—è–µ–º
    user = await get_user_by_id(user_id)
    is_new_user = not user
    
    if is_new_user:
        await create_user(
            user_id=user_id,
            username=username,
            balance=100  # –°—Ç–∞—Ä—Ç–æ–≤—ã–π –±–æ–Ω—É—Å
        )
    
    # –†–∞–∑–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã –¥–ª—è –Ω–æ–≤—ã—Ö –∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    if is_new_user:
            welcome_text = f"""
‚öΩ <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ FootyCards 2!</b>

üéØ <b>–ù–∞—á–Ω–∏ —Å–≤–æ—ë —Ñ—É—Ç–±–æ–ª—å–Ω–æ–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ:</b>

<blockquote>
üì¶ <b>1. –û—Ç–∫—Ä—ã–≤–∞–π –ø–∞–∫–∏</b> - –ù–∞—á–Ω–∏ —Å –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –ø–∞–∫–∞ –≤ –º–∞–≥–∞–∑–∏–Ω–µ
üîÑ <b>2. –ü–æ–ª—É—á–∞–π –∫–∞—Ä—Ç—ã</b> - –°–æ–±–∏—Ä–∞–π —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ñ—É—Ç–±–æ–ª–∏—Å—Ç–æ–≤
üéÆ <b>3. –ò–≥—Ä–∞–π –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π</b> - –£—á–∞—Å—Ç–≤—É–π –≤ –∏–≥—Ä–æ–≤—ã—Ö —Ä–µ–∂–∏–º–∞—Ö
üíé <b>4. –£–ª—É—á—à–∞–π –∫–æ–ª–ª–µ–∫—Ü–∏—é</b> - –ü–æ–∫—É–ø–∞–π –Ω–æ–≤—ã–µ –ø–∞–∫–∏ –Ω–∞ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –º–æ–Ω–µ—Ç—ã
</blockquote>

üéÅ <b>–ü—Ä—è–º–æ —Å–µ–π—á–∞—Å –¥–æ—Å—Ç—É–ø–µ–Ω –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø–∞–∫!</b>
üí´ –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è <b>–∫–∞–∂–¥—ã–µ 3 —á–∞—Å–∞</b> - –Ω–µ –ø—Ä–æ–ø—É—Å—Ç–∏!

üí∞ <b>–°—Ç–∞—Ä—Ç–æ–≤—ã–π –±–æ–Ω—É—Å:</b> 100 –º–æ–Ω–µ—Ç –¥–ª—è –ø–µ—Ä–≤—ã—Ö –ø–æ–∫—É–ø–æ–∫!

<i>–ù–∞—á–Ω–∏ —Å –º–∞–≥–∞–∑–∏–Ω–∞ –ø–∞–∫–æ–≤ ‚Üí –æ—Ç–∫—Ä–æ–π –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø–∞–∫ ‚Üí –∏–≥—Ä–∞–π –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π!</i> üöÄ
            """
    else:
        welcome_text = f"""
‚öΩ <b>–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, {username}!</b> üèÜ

üéØ <b>–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ñ—É—Ç–±–æ–ª—å–Ω–æ–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ:</b>

<blockquote>
üì¶ <b>–ú–∞–≥–∞–∑–∏–Ω –ø–∞–∫–æ–≤</b> - –ü—Ä–æ–≤–µ—Ä—å, –≥–æ—Ç–æ–≤ –ª–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø–∞–∫
üéÆ <b>–ò–≥—Ä–æ–≤—ã–µ —Ä–µ–∂–∏–º—ã</b> - –ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π –º–æ–Ω–µ—Ç—ã –¥–ª—è –Ω–æ–≤—ã—Ö –ø–∞–∫–æ–≤
üÉè <b>–ú–æ–∏ –∫–∞—Ä—Ç—ã</b> - –°–º–æ—Ç—Ä–∏ —Å–≤–æ—é –∫–æ–ª–ª–µ–∫—Ü–∏—é –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å
üè™ <b>–ú–∞—Ä–∫–µ—Ç</b> - –û–±–º–µ–Ω–∏–≤–∞–π—Å—è –∫–∞—Ä—Ç–∞–º–∏ —Å –¥—Ä—É–≥–∏–º–∏ –∏–≥—Ä–æ–∫–∞–º–∏
</blockquote>

üí° <b>–ü–æ–º–Ω–∏:</b> –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø–∞–∫ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 3 —á–∞—Å–∞!
‚ö° –ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π –º–æ–Ω–µ—Ç—ã –≤ –∏–≥—Ä–æ–≤—ã—Ö —Ä–µ–∂–∏–º–∞—Ö –¥–ª—è –µ—â—ë –±–æ–ª—å—à–µ –ø–∞–∫–æ–≤!

<i>–ö –Ω–æ–≤—ã–º —Ñ—É—Ç–±–æ–ª—å–Ω—ã–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è–º!</i> ‚öΩ
        """

    button = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üìã –û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é", callback_data="open_menu")]
    ])
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–æ–π –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ –º–µ–Ω—é
    await message.answer(
        text=welcome_text,
        reply_markup=button,
        parse_mode="HTML"
    )
    
    # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    await state.clear()